<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket JSON Test App</title>
  <style>
    textarea {
      width: 100%;
      height: 100px;
      margin-top: 10px;
      margin-bottom: 0;
    }
    .container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .half {
      width: 50%;
    }
    #log {
      height: 150px;
      margin-bottom: 0;
    }
    .input-group {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .input-group input, .input-group textarea {
      width: 40%;
    }
    .input-group button {
      width: 20%;
    }
    #input, #jsonInput {
      margin-top: 20px;  /* Adds margin-top to 'Type a message' input */
    }
    .example {
      font-size: 14px;
      color: gray;
      margin-top: 5px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>WebSocket JSON Test App</h1>

  <div class="input-group">
    <input type="text" id="name" placeholder="Enter your name">
    <input type="text" id="toWhom" placeholder="Enter recipient's name (leave blank for broadcast)">
    <button onclick="clearAll()">Clear All</button>
  </div>

  <input type="text" id="input" placeholder="Type a plain message">
  
  <div class="example">
    <p>JSON Format Example:</p>
    <pre>
{
  "name": "ExampleName",
  "list": [
    { "name": "Item1", "params": "paramValue1" },
    { "name": "Item2", "params": "paramValue2" }
  ]
}
    </pre>
  </div>

  <textarea id="jsonInput" placeholder="Enter a JSON object to send"></textarea>
  <button onclick="sendMessage()">Send</button>

  <div class="container">
    <div class="half">
      <h3>Sent Messages (<span id="sentCounter">0</span>)</h3>
      <textarea id="sentMessages" readonly></textarea>
    </div>
    <div class="half">
      <h3>Received Messages (<span id="receivedCounter">0</span>)</h3>
      <textarea id="receivedMessages" readonly></textarea>
    </div>
  </div>

  <h3>Common Log (<span id="logCounter">0</span>)</h3>
  <textarea id="log" readonly></textarea>

  <script>
    const ws = new WebSocket('ws://localhost:8080');
    let sentCount = 0;
    let receivedCount = 0;
    let logCount = 0;  // Counter for common log messages

    // Store sent messages to avoid logging them again when received
    const sentMessages = [];

    // Function to send plain message or JSON message
    function sendMessage() {
      const input = document.getElementById('input').value.trim();
      const jsonInput = document.getElementById('jsonInput').value.trim();
      const name = document.getElementById('name').value || 'Anonymous';  // Default to 'Anonymous' if no name is provided
      const toWhom = document.getElementById('toWhom').value || '';  // Target recipient, if any
      let messageObject;

      // If there is JSON input, try to parse and send the JSON message
      if (jsonInput) {
        try {
          const parsedJSON = JSON.parse(jsonInput);
          if (!parsedJSON.name || !Array.isArray(parsedJSON.list)) {
            throw new Error("Invalid format: JSON should have 'name' and 'list' (array of objects)");
          }
          // Check that each item in the list has the required fields
          parsedJSON.list.forEach(item => {
            if (!item.name || !item.params) {
              throw new Error("Invalid format: Each item in 'list' should have 'name' and 'params'");
            }
          });

          messageObject = {
            sender: name,
            recipient: toWhom,
            json: parsedJSON,  // Sending the parsed JSON
            timestamp: new Date().toLocaleString()  // Timestamp
          };
        } catch (error) {
          appendMessage('log', `Error: ${error.message}`);
          return;  // Exit the function if the JSON is invalid
        }
      } else {
        // Fallback to sending a plain message if no JSON is provided
        messageObject = {
          sender: name,
          recipient: toWhom,  // If empty, broadcast to all
          message: input,
          timestamp: new Date().toLocaleString()  // Better formatted timestamp
        };
      }

      // Send the message as a JSON string
      ws.send(JSON.stringify(messageObject));

      // Log the sent message in the 'sentMessages' textarea
      sentCount++;
      document.getElementById('sentCounter').textContent = sentCount;
      appendMessage('sentMessages', `${messageObject.timestamp}: You -> ${messageObject.recipient || 'All'}: ${jsonInput ? 'Sent JSON' : messageObject.message}`);

      // Log the message in the common log only once
      appendMessage('log', `${messageObject.timestamp}: You -> ${messageObject.recipient || 'All'}: ${jsonInput ? 'Sent JSON' : messageObject.message}`);
      logCount++;
      document.getElementById('logCounter').textContent = logCount;

      // Store the sent message to prevent duplicate logging
      sentMessages.push(messageObject);

      // Clear inputs after sending
      document.getElementById('input').value = '';
      document.getElementById('jsonInput').value = '';
    }

    // Function to append messages to the textarea
    function appendMessage(textareaId, text) {
      const textarea = document.getElementById(textareaId);
      textarea.value += text + '\n';  // Append message
      textarea.scrollTop = textarea.scrollHeight;  // Auto-scroll to the bottom
    }

    // Handle incoming messages from the WebSocket server
    ws.onmessage = async (event) => {
      const message = event.data instanceof Blob ? await event.data.text() : event.data;

      // Parse the received JSON message
      try {
        const parsedMessage = JSON.parse(message);
        const formattedMessage = `${parsedMessage.timestamp}: ${parsedMessage.sender} -> ${parsedMessage.recipient || 'All'}`;

        // Log the received message and JSON data
        if (parsedMessage.json) {
          // Check the JSON format validity
          if (!parsedMessage.json.name || !Array.isArray(parsedMessage.json.list)) {
            appendMessage('log', `Error: Received JSON has invalid format (missing 'name' or 'list')`);
          } else {
            appendMessage('log', `${formattedMessage}: Received JSON ->`);
            appendMessage('log', `Name: ${parsedMessage.json.name}`);
            parsedMessage.json.list.forEach((item, index) => {
              appendMessage('log', `Item ${index + 1} - Name: ${item.name}, Params: ${item.params}`);
            });
          }
        } else {
          appendMessage('log', `${formattedMessage}: ${parsedMessage.message}`);
        }

        logCount++;
        document.getElementById('logCounter').textContent = logCount;

        // If the message is specifically for this client, show it in 'receivedMessages'
        const name = document.getElementById('name').value || 'Anonymous';
        if (parsedMessage.recipient === name) {
          receivedCount++;
          document.getElementById('receivedCounter').textContent = receivedCount;
          appendMessage('receivedMessages', `${formattedMessage}: ${parsedMessage.json ? 'Received JSON' : parsedMessage.message}`);
        }
      } catch (e) {
        appendMessage('log', `Error parsing message: ${e.message}`);
        console.error('Error parsing JSON message:', e);
      }
    };

    // Function to clear all text areas
    function clearAll() {
      document.getElementById('input').value = '';
      document.getElementById('jsonInput').value = '';
      document.getElementById('sentMessages').value = '';
      document.getElementById('receivedMessages').value = '';
      document.getElementById('log').value = '';
      document.getElementById('sentCounter').textContent = 0;
      document.getElementById('receivedCounter').textContent = 0;
      document.getElementById('logCounter').textContent = 0;
      sentCount = 0;
      receivedCount = 0;
      logCount = 0;
    }
  </script>
</body>
</html>
